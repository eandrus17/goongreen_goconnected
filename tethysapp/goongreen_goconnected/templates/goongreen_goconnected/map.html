{% extends "goongreen_goconnected/base.html" %}
{% load tethys_gizmos %}

{% block header_buttons %}
  <div class="header-button glyphicon-button" data-toggle="tooltip" data-placement="bottom" title="Help">
    <a data-toggle="modal" data-target="#help-modal"><span class="glyphicon glyphicon-question-sign"></span></a>
  </div>
{% endblock %}

{% block app_content %}

<link rel="stylesheet" href="https://js.arcgis.com/4.6/esri/css/main.css">
<script src="https://js.arcgis.com/4.6/"></script>


<script>
require([
  "esri/Map",
  "esri/layers/GraphicsLayer",
  "esri/Graphic",
  // "esri/geometry/Point",
  "esri/tasks/Geoprocessor",
  // "esri/tasks/support/LinearUnit",
  "esri/tasks/support/FeatureSet",
  "esri/views/MapView",
  "dojo/domReady!"
], function(Map, GraphicsLayer, Graphic, Geoprocessor, FeatureSet, MapView){

	//a map with basemap
	var map = new Map({
    basemap: "streets"
	});

    //a graphics layer to show input data and output polygon
    var graphicsLayer = new GraphicsLayer();
    //var graphicsLayer2 = new GraphicsLayer2();
    map.add(graphicsLayer);
    //map.add(graphicsLayer2);

    var view = new MapView({
    container: "viewDiv",
    map: map,
	center: [-111.9, 40.75],
	zoom: 8
    });

	// symbol for polygons
    var fillSymbol = {
          type: "simple-fill", // autocasts as new SimpleFillSymbol()
          color: [226, 119, 40, 0.75],
          outline: { // autocasts as new SimpleLineSymbol()
            color: [255, 255, 255],
            width: 1
          }
        };

	// Geoprocessing service url
	var gpUrl1 = "http://geoserver2.byu.edu/arcgis/rest/services/GoConnected/FindElevChange/GPServer/FindElevChange";
    var gpUrl2 = "http://geoserver2.byu.edu/arcgis/rest/services/GoConnected/IntersectionDensity/GPServer/Intersection%20Density";
    var gpUrl3 = "http://geoserver2.byu.edu/arcgis/rest/services/GoConnected/BusStops/GPServer/Bus%20Stops";

    // create new Geoprocessors
	var gp1 = new Geoprocessor(gpUrl1);
	var gp2 = new Geoprocessor(gpUrl2);
    var gp3 = new Geoprocessor(gpUrl3);

	// define output spatial reference
    gp1.outSpatialReference = { // autocasts as new SpatialReference()
          wkid: 102100 //EPSG3857
        };
    gp2.outSpatialReference = { // autocasts as new SpatialReference()
          wkid: 102100 //EPSG3857
        };
    gp3.outSpatialReference = { // autocasts as new SpatialReference()
          wkid: 102100 //EPSG3857
        };

	// runs the tool on the button click (jQuery)
	$("#submit").click(function () {
	  runmytool1();
	  runmytool2();
	  runmytool3();
	});

	//main function

    function runmytool1(event) {
         //loading symbol, grabbed from web
          $("#loading").html('<image src="http://baxtersonestop.com/wp-content/plugins/cars-seller-auto-classifieds-script/images/loading-1.gif" style="height: 100px"/>');

		  // input parameters
         var cityname = document.getElementById("cityname").value;
         var params = {
            "Expression": cityname,
          };
          gp1.submitJob(params).then(completeCallback, errBack, statusCallback);
    }

	function completeCallback(result){

        gp1.getResultData(result.jobId, "result_poly").then(drawResult, drawResultErrBack);

	}

	function drawResult(data){
	    // -//$("#loading").html('');
	    var polygon_feature = data.value.features[0];

        g = data.value.features[0].attributes['gridcode'];

        var range_val = document.getElementById("Range");
          range_val.innerText = "Maximum change in elevation: " + g + " ft";


		polygon_feature.symbol = fillSymbol;
		graphicsLayer.add(polygon_feature);
	}

	function drawResultErrBack(err) {
        console.log("draw result error: ", err);
    }

	function statusCallback(data) {
        console.log(data.jobStatus);
    }
    function errBack(err) {
        console.log("gp1 error: ", err);
    }

    // main function #2
    function runmytool2(event) {
         //loading symbol, grabbed from web
          // -//$("#loading").html('<image src="http://baxtersonestop.com/wp-content/plugins/cars-seller-auto-classifieds-script/images/loading-1.gif" style="height: 100px"/>');

		  // input parameters
         var cityname2 = document.getElementById("cityname").value;
         var params2 = {
            "Expression": cityname2,
          };
          gp2.submitJob(params2).then(completeCallback2, errBack2, statusCallback2);
    }

	function completeCallback2(result){

        gp2.getResultData(result.jobId, "output_poly_shp").then(drawResult2, drawResultErrBack2);

	}

	function drawResult2(data){
	    $("#loading").html('');
	    var polygon_feature2 = data.value.features[0];

        g2 = data.value.features[0].attributes['gridcode'];

        var intdens = document.getElementById("IntDen");
          intdens.innerText = "Intersections per square mile: " + g2;

		polygon_feature2.symbol = fillSymbol;
		//graphicsLayer2.add(polygon_feature2);
	}

	function drawResultErrBack2(err) {
        console.log("draw result error: ", err);
    }

	function statusCallback2(data) {
        console.log(data.jobStatus);
    }
    function errBack2(err) {
        console.log("gp2 error: ", err);
    }

// main function #3
    function runmytool3(event) {
         //loading symbol, grabbed from web
          // -//$("#loading").html('<image src="http://baxtersonestop.com/wp-content/plugins/cars-seller-auto-classifieds-script/images/loading-1.gif" style="height: 100px"/>');

		  // input parameters
         var cityname3 = document.getElementById("cityname").value;
         var params3 = {
            "Expression": cityname3,
          };
          var busresults = {
	      "Row_Count" : busnum
	      };

          gp3.submitJob(params3).then(completeCallback3, errBack3, statusCallback3);
    }

	function completeCallback3(result){

        gp3.getResultData(result.jobId, "output_poly_shp").then(drawResult3, drawResultErrBack3);

	}

	function drawResult3(data){
	    $("#loading").html('');
	    var polygon_feature3 = busnum;

        g3 = busnum;

        var busstops = document.getElementById("Buses");
          busstops.innerText = "Number of Bus Stops in " + cityname3 + ":" + g3;

		polygon_feature3.symbol = fillSymbol;
		//graphicsLayer3.add(polygon_feature3);
	}

	function drawResultErrBack3(err) {
        console.log("draw result error: ", err);
    }

	function statusCallback3(data) {
        console.log(data.jobStatus);
    }
    function errBack3(err) {
        console.log("gp3 error: ", err);
    }

});
</script>

  <h1>Calculate Connectivity</h1>
<form>
  <!-- <select id="cityname">
    <option disable selected value> --- Select a City --- </option>
    <option>South Jordan</option>
    <option>Draper</option>
    <option>Orem</option>
  </select> -->
  <input type="text" id="cityname"/>

</form>
  <input type="button" id="submit" value="Submit"/>
<br>
<label id="Range"></label>
<br>
<label id="IntDen"></label>
<br>
<label id="Buses"></label>

<div id="loading"></div>

<style>
  #viewDiv {
    padding: 0;
    margin: 0;
    height: 600px;
    width: 900px
  }
</style>

<div id="viewDiv"></div>


{% endblock %}

{# Use the after_app_content block for modals #}
{% block after_app_content %}
   <!-- Help Modal -->
  <div class="modal fade" id="help-modal" tabindex="-1" role="dialog" aria-labelledby="help-modal-label">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h5 class="modal-title" id="help-modal-label">Help</h5>
        </div>
        <div class="modal-body">
          <p>This application calculates a connectivity score for cities in Utah and Salt Lake Counties. THere are three measures used to calculate the score. The first is total elevation change in the city. To calculate the elevation change, enter the city name into box using this syntax:</p>
          <p>"NAME" = 'cityname'</p>
          <p>The second measure is intersection density. Intersection density is calculated using the number of intersections in the city and the area of the city in square miles (intersections/sq. mile).</p>
          <p>To be continued...</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" data-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block app_actions %}
{% endblock %}